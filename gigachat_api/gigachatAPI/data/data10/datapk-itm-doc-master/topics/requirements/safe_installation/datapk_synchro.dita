<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="datapk_synchro">
    <title>Настройка синхронизации с DATAPK</title>
    <body>
        <p>Сервис синхронизации (далее по тексту синхронизатор) передает данные об ОЗ из DATAPK
            v1.16 и v1.17, проводит некоторую обработку и сохраняет их в DATAPK ITM-K. Синхронизатор
            помещен в контейнер и находится в основном архиве поставки. Синхронизатор работает в
            одном из выбранных режимов:</p>
        <ol id="ol_kf4_cks_frb">
            <li>Регулярная синхронизация, с периодом, указанным в конфигурационном файле.</li>
            <li>Разовая синхронизация, которая запускается после ручного ввода команды.</li>
        </ol>
        <p><b>Настройка регулярной синхронизации</b></p>
        <p>Для синхронизации на локальной машине используется порт 443/tcp. Рекомендуется
            использовать регулярную синхронизацию с небольшим интервалом во время первичной
            настройки ОМ и с большим интервалом во время эксплуатации, если есть вероятность
            появления новых ОМ в сети. </p>
        <p>Остановите работу контейнеров с помощью команды <codeph>docker-compose down</codeph>.
            Откройте <codeph
                conref="../../reusable/filepath/env.dita#ReusableComponent_osh_smr_hrb/codeph_rsh_smr_hrb"
            /> файл для настройки регулярной синхронизации с помощью команды:</p>
        <codeblock>vi /opt/datapkitm/.env</codeblock>
        <p>Ниже приведено описание переменных в файле <codeph
                conref="../../reusable/filepath/env.dita#ReusableComponent_osh_smr_hrb/codeph_rsh_smr_hrb"
            />, необходимых для настройки синхронизации:</p>
        <p><cmdname>DATAPK_HOST</cmdname> - IP-адрес DATAPK. Указываемое значения должно иметь синтаксис
            https://172.17.0.1</p>
        <p><cmdname>DATAPK_PORT</cmdname> - Номер порта для подключения. Значение по умолчанию - 443.</p>
        <p><cmdname>DATAPK_VERSION</cmdname> - Версия API DATAPK. Совпадает с версией DATAPK. Уточнить значение можно в
            веб-интерфейсе DATAPK в разделе "Настройка и мониторинг" - "Основные", в поле
            "Информация об изготовителе". Примечание - синхронизация работает начиная с 16 версии
            API DATAPK.</p>
        <p><cmdname>DATAPK_USER</cmdname> - Имя пользователя в веб-интерфейсе DATAPK.</p>
        <p><cmdname>DATAPK_PASSWORD</cmdname> - Пароль пользователя в веб-интерфейсе DATAPK.</p>
        <p><cmdname>ZABBIX_USER</cmdname> - Имя пользователя в веб-интерфейсе DATAPK ITM-K.</p>
        <p><cmdname>ZABBIX_PASSWORD</cmdname> - Пароль пользователя в веб-интерфейсе DATAPK ITM-K. При смене пароля
            пользователя в веб-интерфейсе необходимо обновить его в файле конфигурации.</p>
        <p><cmdname>SYNCHRONIZATION_DELAY_SECONDS</cmdname> - Периодичность в секундах, с которой будет проводиться
            синхронизация. Значение по умолчанию - 60 (секунд). По окончанию первичной настройки
            рекомендуется изменить значение на 3600 (= 1 час). Комментирование этой строки не
            приводит к выключению синхронизатора, а устанавливает значение по умолчанию в 60
            секунд.</p>
        <p>Если требуется изменить значения переменных уже во время эксплуатации ITM-K, то
            необходимо выключить контейнеры с помощью команды <codeph>docker-compose down</codeph>,
            внести изменения в файл <codeph
                conref="../../reusable/filepath/env.dita#ReusableComponent_osh_smr_hrb/codeph_rsh_smr_hrb"
            /> и запустить контейнеры с помощью команды <codeph>docker-compose up -d</codeph>.</p>
        <p>Результат  работы синхронизатора удобнее смотреть в веб-интерфейсе.</p>
        <p><b>Настройка разовой синхронизации</b></p>
        <p>Рекомендуется использовать разовую синхронизацию в случаях, когда нет необходимости в
            регулярных обновлениях. Разовая синхронизация запускает контейнер для передачи данных и
            затем останавливает его. Проверьте, что контейнер синхронизатора находится в состоянии
            "выключен". Для этого проверьте состояние контейнера командой <codeph>docker ps</codeph>. Для
            выключения контейнера используйте команду <codeph>docker stop synchronizer</codeph>. Если
            потребуется возвращение в режим регулярной синхронизации контейнер можно включить
            командой <codeph>docker start synchronizer</codeph></p>
        <p>Для того, чтобы сделать запрос на получение списка ОЗ – выполните команду:</p>
        <codeblock>docker-compose run synchronizer python3 -m src.synchronization</codeblock>
        <p>Если произошла ошибка при синхронизации и в логах встречается сообщение "DBEXECUTEERROR",
            то запустите синхронизацию еще раз. При ручном запуске синхронизатора все действия
            выводятся на экран в режиме реального времени. После выполнения команды контейнер
            выключится автоматически. Результат  работы синхронизатора удобнее смотреть в
            веб-интерфейсе.</p>
        <p><b>Просмотр логов</b></p>
        <p>Проверить работу синхронизатора в режиме регулярной синхронизации и посмотреть вывод
            ошибок с помощью команды просмотра логов <codeph>docker logs synchronizer</codeph></p>
        <p>Вывести последних 10 строк лога синхронизатора можно с помощью команды <codeph>docker logs
                --tail 10 synchronizer</codeph></p>
    </body>
</topic>
